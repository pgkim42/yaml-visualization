version: "3.9"

# [TEST POINT] Extension Fields & Anchors
# 비주얼라이저가 이 'x-' 필드를 무시할지, 아니면 별도 노드로 보여줄지 테스트
x-logging-def: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    tag: "{{.Name}}|{{.ImageName}}|{{.ID}}"

x-common-env: &common-env
  TZ: "Asia/Seoul"
  # [TEST POINT] Boolean vs String handling
  DEBUG_MODE: true
  LOG_LEVEL: "INFO"

x-healthcheck-base: &base-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 20s

services:
  app:
    # [TEST POINT] Merge Key (<<) usage
    <<: *default-logging
    build:
      context: .
      dockerfile: Dockerfile
      # [TEST POINT] List syntax for args instead of Map
      args:
        - JAR_FILE=build/libs/*.jar
        - JAVA_VERSION=17
    image: order-service:${TAG:-latest} # [TEST POINT] Variable Substitution
    container_name: order-service
    ports:
      - target: 8080
        published: 8080
        protocol: tcp
        mode: host
    environment:
      <<: *common-env
      SPRING_PROFILES_ACTIVE: local
      # [TEST POINT] Complex multi-line environment variable
      JAVA_OPTS: >-
        -Xms512m
        -Xmx1024m
        -XX:+UseG1GC
    secrets:
      - source: db_password
        target: /app/secrets/db_password
      - order_cert
    configs:
      - source: app_config
        target: /app/config/application.yml
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      order-network:
        aliases:
          - api-server
    # [TEST POINT] Deep Nesting (Deploy -> Resources -> Limits)
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  postgres:
    image: postgres:15-alpine
    <<: *default-logging
    environment:
      <<: *common-env
      POSTGRES_DB: orderdb
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - type: volume
        source: postgres_data
        target: /var/lib/postgresql/data
      # [TEST POINT] Read-only bind mount with long path
      - ./init-scripts/complex-schema.sql:/docker-entrypoint-initdb.d/10-schema.sql:ro
    healthcheck:
      <<: *base-healthcheck
      test: ["CMD-SHELL", "pg_isready -U order_user"]
    # [TEST POINT] Sysctls (Map syntax)
    sysctls:
      net.core.somaxconn: 1024
      net.ipv4.tcp_keepalive_time: 60

  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --appendonly yes
      --requirepass "complex string with spaces"
    sysctls:
      - net.core.somaxconn=1024 # [TEST POINT] Sysctls (List syntax mixed)
    deploy:
      placement:
        constraints:
          - node.role == manager

  # [TEST POINT] Service with no ports, purely internal
  worker:
    image: order-worker:latest
    init: true # [TEST POINT] Boolean flag
    entrypoint:
      - /bin/sh
      - -c
      # [TEST POINT] Multi-line script with Pipe (|) preserving newlines
      - |
        echo "Starting worker..."
        while true; do
          echo "Processing..."
          sleep 10
        done
    networks:
      - order-network

  # [TEST POINT] Complex Dependencies & Extra Hosts
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "some-other-host:192.168.1.10"
    environment:
      # ... (Standard Kafka envs omitted for brevity) ...
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    depends_on:
      zookeeper:
        condition: service_started
        required: true # [TEST POINT] Explicit required flag

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    # [TEST POINT] Empty dictionary check (Some parsers fail on null/empty)
    labels: {} 

# [TEST POINT] Top-level Secrets
secrets:
  db_password:
    file: ./secrets/db_password.txt
  order_cert:
    external: true # [TEST POINT] External resource

# [TEST POINT] Top-level Configs
configs:
  app_config:
    file: ./config/application.yml
  monitoring_rules:
    content: |
      groups:
        - name: example
          rules:
          - alert: HighRequestLatency
            expr: job:request_latency_seconds:mean5m{job="myjob"} > 0.5

networks:
  order-network:
    driver: overlay # [TEST POINT] Different driver type
    attachable: true
    ipam:
      driver: default
      config:
        - subnet: 10.0.10.0/24
          gateway: 10.0.10.1

volumes:
  postgres_data:
    name: specific-vol-name
    labels:
      com.example.description: "Database Volume"